<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NweOo SMS</title>
  <link rel="stylesheet" href="bootstrap.min.css" />
  <script src="axios.min.js"></script>
  <script src="vue.min.js"></script>
</head>

<body>
  <div class="container mt-2">
    <main>
      <section class="mb-4">
        <div class="alert alert-success" v-show="message">
          {{ message }}
        </div>
        <div class="alert alert-danger" v-show="error">
          {{ error }}
        </div>
        <a href="articles.html" class="btn btn-primary mr-2">
          View articles
        </a>
        <button @click="updateArticles" :disabled="disabled" class="btn btn-primary">
          Update articles
        </button>
      </section>

      <section>
        <h2>Users</h2>
        <div class="table-responsive">
          <table class="table table-hover table-sm">
            <thead>
              <tr>
                <th>Mobile</th>
                <th>Count</th>
                <th>Actions</th>
                <th>Characters</th>
                <th>Expired</th>
                <th><span class="sr-only">action</span></th>
              </tr>
            </thead>
            <tbody>
              <tr v-for="user in users" :key="user.id" :class="user['flash'] && 'flash' || ''">
                <td>{{ user.id }}</td>
                <td>{{ user.total_count }}</td>
                <td>{{ user.session?.total_action }}/21</td>
                <td>{{ user.session?.character_count }}/10001</td>
                <td>{{ new Date(user.session?.expired).toLocaleString() }}</td>
                <td>
                  <button class="btn btn-sm btn-outline-primary" @click="resetUsage(user.number)"
                    :disabled="loading">reset</button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>
    </main>
  </div>

  <script src="socket.io/socket.io.min.js"></script>
  <script>
    const socket = io();

    new Vue({
      el: "main",
      data: {
        users: [],
        loading: false,
        disabled: false,
        message: null,
        error: null,
      },
      methods: {
        resetUsage(number) {
          this.loading = true;
          this.error = null;
          this.message = null;
          return axios('/call?phone=' + number + '&message=.reset').then(() => {
            this.message = 'Success!'
            this.fetchUsers();
          }).catch(e => this.error = 'Failed, ' + e.message)
            .finally(() => this.loading = false);
        },
        fetchUsers() {
          return axios("/api/users").then(({ data }) => {
            this.users = data.map((user) => ({ ...user, flash: false }));
          });
        },
        updateArticles() {
          this.disabled = true;
          this.error = null;
          this.message = null;
          return axios('/update').then(({ data }) => this.message = 'Updating completed.')
            .catch(e => this.error = 'Failed to update! Error`' + e.message + '`')
            .finally(() => this.disabled = false);
        },
      },
      beforeMount() {
        this.fetchUsers();

        socket.on('users:update', ({ id, type }) => {
          this.fetchUsers().then(() => {
            const user = this.users.find((user) => user.id == id);
            user.flash = true;
            setTimeout(() => user.flash = false, 600);
          })
        });
      },
    });
  </script>

  <style>
    .flash {
      background: initial;
      animation: flashlight .5s ease forwards;
    }

    @keyframes flashlight {
      0% {
        background: initial;
      }

      20% {
        background-color: bisque;
      }

      80% {
        background-color: bisque;
      }

      100% {
        background-color: initial;
      }
    }
  </style>
</body>

</html>
